<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inhabited</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --white: #FFFFFF;
      --black: #000000;
      --gray: #E0E0E0;
      --dark-gray: #666666;
      --light-gray: #F5F5F5;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--black);
      overflow: hidden;
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="6" fill="%23FFFFFF"/><circle cx="10" cy="10" r="3" fill="%23000000"/></svg>') 10 10, auto;
      width: 100vw;
      height: 100vh;
    }

    .screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .screen.active {
      display: flex;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes gentleBob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* ===== TITLE SCREEN ===== */
    #title-screen {
      background: var(--black);
      gap: 10px;
    }

    .title {
      font-weight: 900;
      font-size: 2.2rem;
      color: var(--white);
      text-align: center;
      letter-spacing: -1px;
      animation: slideUp 0.8s ease-out;
    }

    .subtitle {
      font-size: 0.95rem;
      color: var(--dark-gray);
      text-align: center;
      margin-bottom: 2.5rem;
      animation: slideUp 0.8s ease-out 0.15s both;
    }

    .btn {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      padding: 15px 35px;
      background: var(--white);
      color: var(--black);
      border: 4px solid var(--white);
      cursor: pointer;
      transition: all 0.15s;
      text-transform: uppercase;
      letter-spacing: 1px;
      animation: slideUp 0.8s ease-out 0.3s both;
    }

    .btn:hover {
      background: var(--gray);
    }

    .btn:active {
      transform: scale(0.97);
    }

    /* ===== NAME SCREEN ===== */
    #name-screen {
      background: var(--black);
      gap: 15px;
    }

    .name-input {
      font-family: 'Poppins', sans-serif;
      font-size: 1.2rem;
      padding: 14px 24px;
      border: 4px solid var(--white);
      background: var(--black);
      color: var(--white);
      text-align: center;
      width: 280px;
      outline: none;
      transition: box-shadow 0.2s;
    }

    .name-input:focus {
      box-shadow: 0 0 0 2px var(--black), 0 0 0 5px var(--white);
    }

    .name-input::placeholder {
      color: var(--dark-gray);
    }

    /* ===== DRAWING SCREEN ===== */
    #draw-screen {
      background: var(--black);
      padding: 20px;
      gap: 0;
    }

    .draw-container {
      background: var(--white);
      border: 4px solid var(--white);
      padding: 24px;
      max-width: 440px;
      width: 90%;
      animation: slideUp 0.5s ease-out;
    }

    .prompt-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .prompt-step {
      font-weight: 900;
      font-size: 0.75rem;
      color: var(--dark-gray);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .prompt-text {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--black);
      margin-bottom: 16px;
      text-align: center;
      line-height: 1.5;
    }

    .pixel-canvas {
      border: 3px solid var(--black);
      cursor: crosshair;
      image-rendering: pixelated;
      background: white;
      display: block;
      margin: 0 auto 16px;
      touch-action: none;
    }

    .color-palette {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .color-btn {
      width: 32px;
      height: 32px;
      border: 3px solid var(--black);
      cursor: pointer;
      transition: transform 0.1s;
    }

    .color-btn:hover {
      transform: scale(1.15);
    }

    .color-btn.active {
      box-shadow: 0 0 0 3px var(--white), 0 0 0 6px var(--black);
    }

    .tools {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 14px;
    }

    .tool-btn {
      padding: 8px 18px;
      background: var(--white);
      border: 3px solid var(--black);
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.1s;
    }

    .tool-btn:hover {
      background: var(--gray);
    }

    .draw-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .draw-actions .btn {
      animation: none;
      padding: 12px 28px;
      font-size: 0.85rem;
    }

    /* Progress bar for steps */
    .step-progress {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border: 2px solid var(--white);
      border-radius: 50%;
      transition: all 0.3s;
    }

    .step-dot.done {
      background: var(--white);
    }

    .step-dot.current {
      background: var(--white);
      box-shadow: 0 0 8px rgba(255,255,255,0.5);
      animation: pulse 1.5s infinite;
    }

    /* ===== COLLECTION SCREEN ===== */
    #collection-screen {
      background: var(--black);
      padding: 30px 20px;
      overflow-y: auto;
    }

    .collection-wrapper {
      max-width: 700px;
      width: 100%;
      animation: slideUp 0.6s ease-out;
    }

    .collection-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .collection-title {
      font-weight: 900;
      font-size: 1.6rem;
      color: var(--white);
      margin-bottom: 4px;
    }

    .collection-sub {
      font-size: 0.85rem;
      color: var(--dark-gray);
    }

    .collection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .collection-card {
      background: var(--white);
      border: 4px solid var(--white);
      padding: 12px;
      animation: slideUp 0.5s ease-out both;
      transition: transform 0.2s;
    }

    .collection-card:nth-child(1) { animation-delay: 0s; }
    .collection-card:nth-child(2) { animation-delay: 0.08s; }
    .collection-card:nth-child(3) { animation-delay: 0.16s; }
    .collection-card:nth-child(4) { animation-delay: 0.24s; }
    .collection-card:nth-child(5) { animation-delay: 0.32s; }

    .collection-card:hover {
      transform: translateY(-4px);
    }

    .collection-card canvas {
      width: 100%;
      aspect-ratio: 1;
      display: block;
      image-rendering: pixelated;
      border: 2px solid var(--black);
      background: white;
    }

    .card-label {
      font-weight: 700;
      font-size: 0.7rem;
      color: var(--dark-gray);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-top: 10px;
      text-align: center;
    }

    .card-prompt {
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--black);
      text-align: center;
      margin-top: 2px;
      line-height: 1.3;
    }

    .collection-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .collection-actions .btn {
      animation: none;
    }

    /* ===== COMPLETION SCREEN ===== */
    #completion-screen {
      background: var(--black);
      gap: 20px;
    }

    .completion-message {
      font-weight: 900;
      font-size: 1.5rem;
      color: var(--white);
      text-align: center;
    }

    .screenshot-preview {
      background: var(--white);
      border: 4px solid var(--white);
      padding: 10px;
    }

    .screenshot-preview img {
      max-width: 600px;
      width: 100%;
      display: block;
      border: 2px solid var(--black);
    }

    /* ===== EXPLORE SCREEN ===== */
    #explore-screen {
      background: var(--black);
    }

    .gallery-item {
      background: white;
      border: 3px solid white;
      padding: 10px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .gallery-item:hover {
      transform: scale(1.02);
    }

    .gallery-item img {
      width: 100%;
      height: auto;
      display: block;
      border: 2px solid black;
    }

    .gallery-item-name {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      color: black;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .gallery-item-date {
      font-family: 'Poppins', sans-serif;
      font-size: 0.75rem;
      color: var(--dark-gray);
      margin-top: 4px;
    }

    /* Image Modal */
    .image-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .image-modal.active {
      display: flex;
    }

    .image-modal-content {
      max-width: 90%;
      max-height: 90%;
      background: white;
      padding: 20px;
      border: 4px solid white;
      position: relative;
    }

    .image-modal-content img {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      border: 3px solid black;
    }

    .image-modal-close {
      position: absolute;
      top: -15px; right: -15px;
      width: 40px; height: 40px;
      background: white;
      border: 3px solid black;
      border-radius: 50%;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-modal-close:hover {
      background: var(--gray);
      transform: scale(1.1);
    }

    .image-modal-name {
      font-weight: 700;
      color: black;
      margin-top: 15px;
      font-size: 1.1rem;
      text-align: center;
    }

    /* ===== LETTER SCREEN ===== */
    #letter-screen {
      background: var(--black);
      padding: 20px;
    }

    .letter-container {
      background: var(--white);
      border: 4px solid var(--white);
      padding: 30px;
      max-width: 480px;
      width: 90%;
      animation: slideUp 0.5s ease-out;
    }

    .letter-title {
      font-weight: 900;
      font-size: 1.05rem;
      color: var(--black);
      text-align: center;
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .letter-title em {
      font-style: italic;
      border-bottom: 2px solid var(--black);
      padding-bottom: 1px;
    }

    .letter-subtitle {
      font-size: 0.8rem;
      color: var(--dark-gray);
      text-align: center;
      margin-bottom: 20px;
    }

    .letter-textarea {
      font-family: 'Poppins', sans-serif;
      font-size: 0.9rem;
      line-height: 1.7;
      width: 100%;
      height: 180px;
      padding: 16px;
      border: 3px solid var(--black);
      background: var(--white);
      color: var(--black);
      resize: none;
      outline: none;
      transition: box-shadow 0.2s;
    }

    .letter-textarea:focus {
      box-shadow: 0 0 0 2px var(--white), 0 0 0 5px var(--black);
    }

    .letter-textarea::placeholder {
      color: #bbb;
      font-style: italic;
    }

    .letter-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .letter-actions .btn {
      animation: none;
      padding: 12px 28px;
      font-size: 0.85rem;
    }

    /* Letter card in collection */
    .collection-letter {
      grid-column: 1 / -1;
      background: var(--white);
      border: 4px solid var(--white);
      padding: 20px 24px;
      animation: slideUp 0.5s ease-out 0.4s both;
    }

    .collection-letter .letter-card-title {
      font-weight: 900;
      font-size: 0.8rem;
      color: var(--black);
      text-align: center;
      margin-bottom: 12px;
      letter-spacing: -0.3px;
    }

    .collection-letter .letter-card-text {
      font-size: 0.85rem;
      color: var(--black);
      line-height: 1.8;
      text-align: center;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Loading spinner */
    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      grid-column: 1 / -1;
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--dark-gray);
      font-size: 0.85rem;
      margin-top: 15px;
    }

    .saving-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .saving-overlay .saving-text {
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 20px;
    }

    @media (max-width: 600px) {
      .title { font-size: 1.5rem; }
      .draw-container { padding: 16px; }
      .pixel-canvas { width: 256px !important; height: 256px !important; }
      .collection-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .prompt-text { font-size: 0.95rem; }
    }

    @media (max-width: 380px) {
      .pixel-canvas { width: 220px !important; height: 220px !important; }
      .collection-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    }
  </style>
</head>
<body>

  <!-- Title Screen -->
  <div id="title-screen" class="screen active">
    <div class="title">Inhabited</div>
    <button class="btn" onclick="goToName()">Start</button>
    <button class="btn" onclick="showExplore()" style="margin-top: 10px; background: var(--black); color: var(--white); border-color: var(--white);">Explore</button>
  </div>

  <!-- Name Screen -->
  <div id="name-screen" class="screen">
    <div class="title" style="font-size: 1.3rem; margin-bottom: 5px;">What's your name?</div>
    <div class="subtitle" style="margin-bottom: 2rem;">We'll put it on your collection</div>
    <input type="text" id="user-name" placeholder="Name" class="name-input" maxlength="20">
    <button class="btn" onclick="startDrawing()" style="margin-top: 20px;">Next</button>
  </div>

  <!-- Drawing Screen -->
  <div id="draw-screen" class="screen">
    <div class="step-progress" id="step-progress"></div>
    <div class="draw-container">
      <div class="prompt-header">
        <span class="prompt-step" id="prompt-step">01 / 05</span>
      </div>
      <div class="prompt-text" id="prompt-text">Draw your favorite plant</div>

      <canvas id="draw-canvas" class="pixel-canvas" width="320" height="320"></canvas>

      <div class="color-palette" id="color-palette"></div>

      <div class="tools">
        <button class="tool-btn" onclick="clearDrawCanvas()">Clear</button>
        <button class="tool-btn" onclick="fillDrawCanvas()">Fill</button>
      </div>

      <div class="draw-actions">
        <button class="btn" onclick="skipPrompt()" style="background: var(--black); color: var(--white); border-color: var(--black);">Skip</button>
        <button class="btn" onclick="submitDrawing()">Done</button>
      </div>
    </div>
  </div>

  <!-- Letter Screen -->
  <div id="letter-screen" class="screen">
    <div class="step-progress" id="step-progress-letter"></div>
    <div class="letter-container">
      <div class="letter-title">To <em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</em> , Who Will Never Read This</div>
      <div class="letter-subtitle">Write the words you never got to say</div>
      <textarea id="letter-text" class="letter-textarea" placeholder="Write here..."></textarea>
      <div class="letter-actions">
        <button class="btn" onclick="skipLetter()" style="background: var(--black); color: var(--white); border-color: var(--black);">Skip</button>
        <button class="btn" onclick="submitLetter()">Done</button>
      </div>
    </div>
  </div>

  <!-- Collection Screen -->
  <div id="collection-screen" class="screen">
    <div class="collection-wrapper">
      <div class="collection-header">
        <div class="collection-title" id="collection-title">...'s collection</div>
        <div class="collection-sub">Five things that are mine</div>
      </div>
      <div class="collection-grid" id="collection-grid"></div>
      <div class="collection-actions">
        <button class="btn" onclick="saveCollection()">Save</button>
        <button class="btn" onclick="restartGame()" style="background: var(--black); color: var(--white); border-color: var(--white);">Start Over</button>
      </div>
    </div>
  </div>

  <!-- Completion Screen -->
  <div id="completion-screen" class="screen">
    <div class="completion-message">Your collection has been saved!</div>
    <div class="screenshot-preview" id="screenshot-container"></div>
    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
      <button class="btn" onclick="switchScreen('collection-screen')">View Collection</button>
      <button class="btn" onclick="showExplore()">Explore</button>
      <button class="btn" onclick="restartGame()" style="background: var(--black); color: var(--white); border-color: var(--white);">Start Over</button>
    </div>
  </div>

  <!-- Explore Screen -->
  <div id="explore-screen" class="screen">
    <div style="width: 90%; max-width: 1200px; height: 90%; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: white; font-weight: 700; font-size: 1.5rem;">Shared Collections</h2>
        <button class="btn" onclick="backFromExplore()" style="animation: none; padding: 10px 25px;">Back</button>
      </div>
      <div id="gallery-container" style="flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; background: rgba(255,255,255,0.05); border: 2px solid white;">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <div class="loading-text">Loading collections...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="image-modal" class="image-modal" onclick="closeImageModal()">
    <div class="image-modal-content" onclick="event.stopPropagation()">
      <div class="image-modal-close" onclick="closeImageModal()">×</div>
      <img id="modal-image" src="" alt="">
      <div class="image-modal-name" id="modal-name"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // ===== FIREBASE INIT =====
    const firebaseConfig = {
      apiKey: "AIzaSyA8hT35rl_8uO27LoBSAWjU89wRtF4TxL4",
      authDomain: "unsent-c49a2.firebaseapp.com",
      projectId: "unsent-c49a2",
      storageBucket: "unsent-c49a2.firebasestorage.app",
      messagingSenderId: "736167237909",
      appId: "1:736167237909:web:3792aaa732ebae0430311c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log('Firebase initialized for Inhabited');

    // ===== PROMPTS =====
    const PROMPTS = [
      { label: '01', text: 'Draw your favorite plant', tag: 'Plant' },
      { label: '02', text: 'Draw the house you want to live in', tag: 'Home' },
      { label: '03', text: 'Draw something you find cute', tag: 'Cute Thing' },
      { label: '04', text: "Draw something you can't live without", tag: 'Essential' },
      { label: '05', text: 'Draw yourself', tag: 'Me' },
    ];

    // ===== STATE =====
    let state = {
      userName: '',
      currentStep: 0,
      drawings: [],
      letterText: ''
    };

    // Canvas config
    const GRID_SIZE = 40;
    const PIXEL_SIZE = 8;
    let isDrawing = false;
    let currentColor = '#000000';

    const colors = [
      '#000000', '#1a1a1a', '#333333', '#4d4d4d', '#666666',
      '#808080', '#999999', '#b3b3b3', '#cccccc', '#e6e6e6', '#ffffff'
    ];

    // ===== SCREEN NAVIGATION =====
    function switchScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function goToName() {
      switchScreen('name-screen');
      setTimeout(() => document.getElementById('user-name').focus(), 300);
    }

    // ===== NAME → DRAW =====
    function startDrawing() {
      const name = document.getElementById('user-name').value.trim() || '...';
      state.userName = name;
      state.currentStep = 0;
      state.drawings = [];
      state.letterText = '';
      showDrawScreen();
    }

    // ===== DRAW SCREEN =====
    function showDrawScreen() {
      switchScreen('draw-screen');
      const step = state.currentStep;
      const p = PROMPTS[step];

      document.getElementById('prompt-step').textContent = p.label + ' / 05';
      document.getElementById('prompt-text').textContent = p.text;

      const prog = document.getElementById('step-progress');
      prog.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const dot = document.createElement('div');
        dot.className = 'step-dot';
        if (i < step) dot.classList.add('done');
        if (i === step) dot.classList.add('current');
        prog.appendChild(dot);
      }

      setupCanvas('draw-canvas');
      initColorPalette('color-palette');
      clearCanvas('draw-canvas');
    }

    // ===== CANVAS FUNCTIONS =====
    function initColorPalette(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      colors.forEach((color, i) => {
        const btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.background = color;
        if (color === currentColor) btn.classList.add('active');
        btn.onclick = () => {
          currentColor = color;
          container.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
        container.appendChild(btn);
      });
    }

    function setupCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      const newCanvas = canvas.cloneNode(true);
      canvas.parentNode.replaceChild(newCanvas, canvas);

      const c = newCanvas;
      c.addEventListener('mousedown', (e) => { isDrawing = true; drawPixel(c, e.offsetX, e.offsetY); });
      c.addEventListener('mousemove', (e) => { if (isDrawing) drawPixel(c, e.offsetX, e.offsetY); });
      c.addEventListener('mouseup', () => isDrawing = false);
      c.addEventListener('mouseleave', () => isDrawing = false);

      c.addEventListener('touchstart', (e) => { e.preventDefault(); isDrawing = true; handleTouch(c, e); }, { passive: false });
      c.addEventListener('touchmove', (e) => { e.preventDefault(); if (isDrawing) handleTouch(c, e); }, { passive: false });
      c.addEventListener('touchend', () => isDrawing = false);
    }

    function handleTouch(canvas, e) {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (touch.clientX - rect.left) * scaleX;
      const y = (touch.clientY - rect.top) * scaleY;
      drawPixel(canvas, x, y);
    }

    function drawPixel(canvas, x, y) {
      const ctx = canvas.getContext('2d');
      const gx = Math.floor(x / PIXEL_SIZE);
      const gy = Math.floor(y / PIXEL_SIZE);
      ctx.fillStyle = currentColor;
      ctx.fillRect(gx * PIXEL_SIZE, gy * PIXEL_SIZE, PIXEL_SIZE, PIXEL_SIZE);
    }

    function clearCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function fillCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = currentColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function clearDrawCanvas() { clearCanvas('draw-canvas'); }
    function fillDrawCanvas() { fillCanvas('draw-canvas'); }

    // ===== SUBMIT / SKIP =====
    function submitDrawing() {
      const canvas = document.getElementById('draw-canvas');
      const dataURL = canvas.toDataURL();

      state.drawings.push({
        dataURL: dataURL,
        prompt: PROMPTS[state.currentStep],
        skipped: false
      });

      advanceStep();
    }

    function skipPrompt() {
      state.drawings.push({
        dataURL: null,
        prompt: PROMPTS[state.currentStep],
        skipped: true
      });
      advanceStep();
    }

    function advanceStep() {
      state.currentStep++;
      if (state.currentStep >= PROMPTS.length) {
        showLetterScreen();
      } else {
        showDrawScreen();
      }
    }

    // ===== LETTER SCREEN =====
    function showLetterScreen() {
      switchScreen('letter-screen');
      document.getElementById('letter-text').value = '';

      const prog = document.getElementById('step-progress-letter');
      prog.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const dot = document.createElement('div');
        dot.className = 'step-dot';
        if (i < 5) dot.classList.add('done');
        if (i === 5) dot.classList.add('current');
        prog.appendChild(dot);
      }

      setTimeout(() => document.getElementById('letter-text').focus(), 300);
    }

    function submitLetter() {
      state.letterText = document.getElementById('letter-text').value.trim();
      showCollection();
    }

    function skipLetter() {
      state.letterText = '';
      showCollection();
    }

    // ===== COLLECTION SCREEN =====
    function showCollection() {
      switchScreen('collection-screen');

      document.getElementById('collection-title').textContent = state.userName + "'s Collection";

      const grid = document.getElementById('collection-grid');
      grid.innerHTML = '';

      state.drawings.forEach((d, i) => {
        const card = document.createElement('div');
        card.className = 'collection-card';

        if (d.skipped) {
          card.innerHTML = `
            <div style="width:100%; aspect-ratio:1; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:0.8rem;">Skipped</div>
            <div class="card-label">${d.prompt.label}</div>
            <div class="card-prompt">${d.prompt.tag}</div>
          `;
        } else {
          const cvs = document.createElement('canvas');
          cvs.width = 320;
          cvs.height = 320;
          const ctx = cvs.getContext('2d');

          const img = new Image();
          img.onload = () => ctx.drawImage(img, 0, 0, 320, 320);
          img.src = d.dataURL;

          const labelDiv = document.createElement('div');
          labelDiv.className = 'card-label';
          labelDiv.textContent = d.prompt.label;

          const promptDiv = document.createElement('div');
          promptDiv.className = 'card-prompt';
          promptDiv.textContent = d.prompt.tag;

          card.appendChild(cvs);
          card.appendChild(labelDiv);
          card.appendChild(promptDiv);
        }

        grid.appendChild(card);
      });

      // Add letter card if text exists
      if (state.letterText) {
        const letterCard = document.createElement('div');
        letterCard.className = 'collection-letter';
        letterCard.innerHTML = `
          <div class="letter-card-title">To ___ , Who Will Never Read This</div>
          <div class="letter-card-text">${state.letterText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
        `;
        grid.appendChild(letterCard);
      }
    }

    // ===== SAVE / SCREENSHOT + FIREBASE =====
    function saveCollection() {
      const padding = 30;
      const cardSize = 160;
      const gap = 16;
      const cols = Math.min(state.drawings.length, 5);
      const totalW = padding * 2 + cols * cardSize + (cols - 1) * gap;
      const headerH = 80;
      const labelH = 50;
      const letterH = state.letterText ? 120 : 0;
      const letterPad = state.letterText ? 20 : 0;
      const totalH = headerH + padding + cardSize + labelH + letterPad + letterH + padding;

      const canvas = document.createElement('canvas');
      canvas.width = totalW * 2;
      canvas.height = totalH * 2;
      const ctx = canvas.getContext('2d');
      ctx.scale(2, 2);

      // Background
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, totalW, totalH);

      // Header
      ctx.fillStyle = '#FFFFFF';
      ctx.font = 'bold 22px Poppins, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(state.userName + "'s Collection", totalW / 2, 38);

      ctx.fillStyle = '#666666';
      ctx.font = '12px Poppins, sans-serif';
      const now = new Date();
      const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
      ctx.fillText(dateStr, totalW / 2, 58);

      // Draw cards
      const startX = padding;
      const startY = headerH + padding;

      let loadCount = 0;
      const totalToLoad = state.drawings.filter(d => !d.skipped).length;

      function finishSave() {
        // Draw labels
        state.drawings.forEach((d, i) => {
          const x = startX + i * (cardSize + gap);
          ctx.fillStyle = '#999999';
          ctx.font = '9px Poppins, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(d.prompt.label, x + cardSize / 2, startY + cardSize + 18);

          ctx.fillStyle = '#FFFFFF';
          ctx.font = 'bold 11px Poppins, sans-serif';
          ctx.fillText(d.prompt.tag, x + cardSize / 2, startY + cardSize + 34);
        });

        // Draw letter section
        if (state.letterText) {
          const letterY = startY + cardSize + labelH + letterPad;
          
          ctx.strokeStyle = '#333333';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(padding, letterY);
          ctx.lineTo(totalW - padding, letterY);
          ctx.stroke();
          
          ctx.fillStyle = '#999999';
          ctx.font = 'italic 10px Poppins, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('To ___ , Who Will Never Read This', totalW / 2, letterY + 20);
          
          ctx.fillStyle = '#FFFFFF';
          ctx.font = '11px Poppins, sans-serif';
          const maxLineW = totalW - padding * 2 - 20;
          const lines = wrapText(ctx, state.letterText, maxLineW);
          lines.slice(0, 5).forEach((line, i) => {
            ctx.fillText(line, totalW / 2, letterY + 42 + i * 18);
          });
          if (lines.length > 5) {
            ctx.fillText('...', totalW / 2, letterY + 42 + 5 * 18);
          }
        }

        // Download
        const link = document.createElement('a');
        link.download = state.userName + '-collection.png';
        link.href = canvas.toDataURL();
        link.click();

        // Save to Firebase
        const imageData = canvas.toDataURL();
        saveToFirebase(imageData, state.userName, state.letterText);

        // Show preview
        const container = document.getElementById('screenshot-container');
        container.innerHTML = '';
        const img2 = document.createElement('img');
        img2.src = imageData;
        container.appendChild(img2);

        switchScreen('completion-screen');
      }

      if (totalToLoad === 0) {
        state.drawings.forEach((d, i) => {
          const x = startX + i * (cardSize + gap);
          ctx.strokeStyle = '#333333';
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);
          ctx.strokeRect(x, startY, cardSize, cardSize);
          ctx.setLineDash([]);
        });
        finishSave();
        return;
      }

      state.drawings.forEach((d, i) => {
        const x = startX + i * (cardSize + gap);

        if (d.skipped) {
          ctx.strokeStyle = '#333333';
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);
          ctx.strokeRect(x, startY, cardSize, cardSize);
          ctx.setLineDash([]);
        } else {
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(x, startY, cardSize, cardSize);

          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, x, startY, cardSize, cardSize);
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, startY, cardSize, cardSize);
            loadCount++;
            if (loadCount >= totalToLoad) finishSave();
          };
          img.src = d.dataURL;
        }
      });
    }

    // ===== FIREBASE: SAVE COLLECTION =====
    async function saveToFirebase(imageData, userName, letterText) {
      try {
        await db.collection('inhabited_collections').add({
          image: imageData,
          name: userName,
          letterText: letterText || '',
          timestamp: Date.now()
        });
        console.log('Collection saved to Firebase!');
      } catch (error) {
        console.error('Firebase save failed:', error);
      }
    }

    // ===== FIREBASE: LOAD GALLERY =====
    async function loadGalleryFromFirebase() {
      try {
        const snapshot = await db.collection('inhabited_collections')
          .orderBy('timestamp', 'desc')
          .limit(50)
          .get();

        const collections = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          collections.push(data);
        });
        return collections;
      } catch (error) {
        console.error('Firebase load failed:', error);
        return [];
      }
    }

    // ===== EXPLORE =====
    let previousScreen = 'title-screen';

    async function showExplore() {
      previousScreen = document.querySelector('.screen.active').id;
      switchScreen('explore-screen');

      const container = document.getElementById('gallery-container');
      container.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>
          <div class="loading-text">Loading collections...</div>
        </div>
      `;

      const spaces = await loadGalleryFromFirebase();

      if (spaces.length === 0) {
        container.innerHTML = '<div style="color:white; text-align:center; padding:40px; grid-column:1/-1;">No shared collections yet. Be the first to create one!</div>';
      } else {
        container.innerHTML = '';
        spaces.forEach(space => {
          const item = document.createElement('div');
          item.className = 'gallery-item';

          const date = new Date(space.timestamp);
          const dateStr = `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;

          item.innerHTML = `
            <img src="${space.image}" alt="${space.name}'s Collection">
            <div class="gallery-item-name">${escapeHtml(space.name)}'s Collection</div>
            <div class="gallery-item-date">${dateStr}</div>
          `;
          item.onclick = () => openImageModal(space.image, space.name);
          container.appendChild(item);
        });
      }
    }

    function backFromExplore() {
      switchScreen(previousScreen);
    }

    function openImageModal(src, name) {
      document.getElementById('modal-image').src = src;
      document.getElementById('modal-name').textContent = name + "'s Collection";
      document.getElementById('image-modal').classList.add('active');
    }

    function closeImageModal() {
      document.getElementById('image-modal').classList.remove('active');
    }

    // ===== RESTART =====
    function restartGame() {
      state = { userName: '', currentStep: 0, drawings: [], letterText: '' };
      document.getElementById('user-name').value = '';
      document.getElementById('letter-text').value = '';
      switchScreen('title-screen');
    }

    // ===== HELPER: word wrap for canvas =====
    function wrapText(ctx, text, maxWidth) {
      const lines = [];
      let currentLine = '';

      for (const char of text) {
        if (char === '\n') {
          lines.push(currentLine);
          currentLine = '';
          continue;
        }
        const testLine = currentLine + char;
        if (ctx.measureText(testLine).width > maxWidth && currentLine) {
          lines.push(currentLine);
          currentLine = char;
        } else {
          currentLine = testLine;
        }
      }
      if (currentLine) lines.push(currentLine);
      return lines;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Enter key on name input
    document.getElementById('user-name').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') startDrawing();
    });
  </script>

</body>
</html>
